---
layout: post
title: JIT 컴파일러?
categories: [Java]
---

![img_2.png](https://github.com/user-attachments/assets/d344ae6c-8da1-4544-8c8f-c47adab0843e)

1. 자바 파일(*.java)을 컴파일러를 통해 클래스 파일(*.class/바이트코드)로 만든다.
2. 이후 자바 바이트 코드를 JVM이 읽고 실행한다.


> #### 자바 바이트 코드
> JVM이 이해할 수 있는 언어로 변화나된 자바 소스 코드
> 자바 컴파일러에 의해 변환되는 코드의 명령어 크기가 1 바이트여서 자바 바이트 코드라 한다.
> 자바 바이트 코드는 자바 가상 머신만 설치되어 있으면, 어떤 운영체제에서도 실행될 수 있다.



<br><br><br>

## 컴파일러와 인터프리터
컴파일러와 인터프리터 모두 고수준 언어를 기계어로 변환시킨디ㅏ.  

컴파일러는 소스코드 전체를 한 번에 번역하여 목적 파일로 만들어 메모리에 적재하는 방식이다.  
인터프리터는 소스코드를 한 행씩 중간 코드로 번역 후 실행한다.  

#### 컴파일러
- 컴파일이 완료된 실행 파일은 컴퓨터에서 빠르게 실행할 수 있어 효율적이다.
- 기계어로 번역되기 때문에 프로그램 코드가 유출되지않는다.
- 컴파일 에러와 관련된 에러를 초기에 발견할 수 있다.
- 코드 수정시 다시 컴파일 해야 한다.
- 컴파일 시간이 비교적 느리며, 수정이 빈번한 경우 문제가 발생할 수 있다.

#### 인터프리터
- 메모리를 사용하지 않으며, 시스템 간 이식성이 좋다.
- 전체 코드를 다시 컴파일할 필요가 없기 때문에 코드 수정에 용이한다.
- 매번 번역 과정을 거쳐야 하기 때문에 실행 속도가 느려 컴파일러에 비해 느리다.
- 중간 코드로 해석되기 때문에 프로그램의 코드가 유출될 수 있다.


<br><br><br>



## 자바 코드를 실행하는 과정
1. 자바 파일을 자바 컴파일러를 통해 바이트코드 파일로 컴파일 한다. 
   자바 컴파일러는 자바 소스코드를 JVM을 위한 기계어로 번역한다.
   
2. JVM의 실행 엔진 내에 있는 자바 인터프리터를 통해 
   바이트 코드를 특정 환경의 기계어로 번역하고 실행한다.




<br><br><br>


자바는 코드를 실행하기 위해서는 바이트코드로 컴파일하는 과정과, 바이트코드를 인터프리하는 과정을 거쳐야 한다.
즉, 컴파일 과정만 필요한 다른 프로그래밍 언어보다 느리다.   

거기에 더하여 인터프리터는 컴파일러보다 속도가 느리기 때문에 성능이 떨어진다. 
이러한 문제를 개선하기 위해 나온 것이 JIT 컴파일러이다. 


JIT 컴파일은 코드가 실행되는 과정에 실시간으로 일어나며(그래서 Just-In-Time이다), 
전체 코드의 필요한 부분만 변환한다. 기계어로 변환된 코드는 캐시에 저장되기 때문에 재사용 시 컴파일을 다시 할 필요가 없다.




<br><br><br>

## Just-In-Time 컴파일러
Java와 같은 JVM 기반 언어에서 사용되는 컴파일러로, 프로그램 실행 중 바이트코드를 기계어로 변환하는 컴파일 기법

기계어로 변환된 코드를 캐시에 저장한 후 재사용시 컴파일을 다시 하지 않아도 되기 때문에 성능이 좋다.

하지만 모든 코드들을 캐시하는건 아니다. JVM은 내부에서 자주 수행되는 코드들을 선별하여 캐시 공간에 넣어 둔다.




<br>

### 어떤 기준으로 선별할까?

#### 1. 프로파일링
   JVM은 프로그램 실행 중 메섯드의 호출 빈도, 실행 시간을 모니터링한다.  
   이 데이터를 기반으로 JVM은 어떤 메서드가 핫스팟 메서드인지 판단한다. 
#### 2. 임계값 설정
   JVM은 특정 임계값을 설정하고, 메서드 호출 빈도가 임계값을 넘는 경우 해당 코드를 JIT 컴파일 대상으로 선정한다.  
   임계값은 JVM에 따라 다르다.
#### 3. JIT 컴파일
   프로파일링 데이터와 임계값을 바탕으로, JVM은 핫스팟 메서드를 JIT 컴파일 하여 네이티브 코드로 변환한다.
   JIT 컴파일러는 이 메서드를 최적화하여 다음 실행 시 성능이 향상되도록 합니다.
#### 4. 캐싱
   JIT 컴파일러는 컴파일된 메서드를 캐시에 저장한다.  
   그 후 동일한 메서드가 다음에 호출될 때 빠르게 접근할 수 있다. 
   캐시는 메서드의 네이티브 코드를 저장하고, 필요할 때 재사용하여 성능을 향상시킨다.
#### 5. 스케줄링
   JIT 컴파일은 CPU 자원과 메모리 사용량을 고려하여 실행된다.
   
   메서드 호출빈도가 높은 경우 JIT 컴파일 우선순위를 높여, 많이 호출되는 메서드일수록 삘리 최적화하려고 한다.  
   하지만 CPU 사용량이 높다면, JIT 컴파일을 늦추거나 제한할 수 있습니다.
   CPU 부하가 낮은 시점에 컴파일 작업이 수행될 수 있도록 하며, 애플리케이션의 전체 성능에 영향을 미치지 않도록 한다.
#### 6. 정책 조정  
   JVM은 다양한 정책을 통해 핫스팟 메서드를 최적화할 수 있다.
   특정 메서드의 호출 빈도가 급증하면 JVM은 해당 메서드에 대해 추가 최적화를 적용할 수 있다.

<br>

프로파일링과 임계값을 기반으로 핫스팟을 선정하여 캐싱한다.  
호출 빈도와 실행 시간을 모니터링하여, 자주 호출되거나 성능이 중요한 메서드에 대해 JIT 컴파일과 캐싱을 수행하는 방식이다.
이를 통해 성능을 최적화하고, 실행 속도를 향상 시킬 수 있다.


<br><br><br>


## C1, C2
실제로 JVM의 JIT 컴파일러 내부에는 2가지 컴파일러인 C1컴파일러와 C2컴파일러가 있다.
C1은 level1~3, C2는 level4를 담당한다.

### C1 - Client Compiler
빠른 시작 시간을 목표로 설계된 Client 모드에서 동작하는 JIT 컴파일러이다.  
간단한 최적화를 수행하며, 복잡한 최적화는 적용하지 않기 때문에 코드 컴파일에 시간이 적게 걸린다.
서버 어플리케이션보다는 데스크탑 어플리케이션,
GUI 어플리케이션과 같은 짧은 실행 시간과 빠른 응답속도가 중요한 프로그램에 적합하다.
  
- 프로그램이 실행될 때 빠르게 바이트코드를 기계어로 변환하여 바로 실행할 수 있다.
- 인라인, dead code elimination, 루프 최적화등 기본 최적화 작업만 수행한다.
- 최적화를 간단히 하기 때문에 프로그램이 빠르게 시작할 수 있다.


### C2 - Server Compiler
서버 모드에섯 동작하며, 고성능을 목표로 복잡한 최적화를 수행하는 JIT 컴파일러이다.  
시작 시간은 느리지만, 장기 실행 프로그램에 더 적합한 컴파일러로, 성능이 중요한 서버 환경에서 주로 사용한다.

- 복잡한 루프 전환, 인라인 확정, 탈출 분석 등 고급 최적화를 수행하여 성능을 극대화한다.
- 고급 최적화를 적용하기 때문에 컴파일 시간이 상대적으로 길며, 프로그램 시작 시점에서는 더 많은 시간이 소요된다.
- 최적화된 코드로 인해 CPU, 메모리 사용을 줄인다.  


## Tiered Compilation (계층적 컴파일)
C1, C2 컴파일러의 장점을 결합한 JVM 컴파일 전략이다.  
C1 컴파일러로 빠르게 바이트 코드를 기계어로 변환하여 실행하고, 프로그램이 더 오래 실행되면,
C2 컴파일러로 고급 최적화를 수행한다. 



<br><br><br>

## 특징
### 1. 성능 최적화
바이트 코드를 실행하는 대신, 자주 실행되는 코드를 JIT 컴파일러가 직접 기계어로 변환하면 더 빠르게 실행된다.
이를 통해 실행 성능이 향상된다.

### 2. 동적 최적화
JIT 컴파일러는 실행 중에 코드의 사용 패턴을 분석하여 최적회된 코드를 생성할 수 있다.

### 3. 메모리 효율성
필요할 때만 바이트 코드를 컴파일하기 때문에, 메모리 사용을 최적화할 수 있다.

### 4. 호환성 유지
바이트 코드를 처음부터 기계어로 변환하는 AOT(Ahead-of-Time) 컴파일러와 달리, JIT는
바이트 코드 상태로 유지하다가 실행 시점에 필요한 부분을 변환한다.    
이를 통해 다양한 플랫폼에서 동일한 바이트 코드를 실행할 수 있는 JVM의 이식성을 유지하면서
성능을 개선할 수 있다.

> AOT 컴파일
> 프로그램 코드를 실행하기 전 미리 기계어로 변환하는 방식  
> 실행 시점에 추가적인 컴파일 작업이 필요하지 않아 실행 속도가 빠르다.  
> AOT로 생성된 기계어는 특정 플랫폼에서만 실행이 가능하다.  
> 플랫폼에 종속적이며, 다른 환경에서 실행하려면 별도로 AOT 컴파일 해야 한다.



<br><br><br>

## JIT의 작동 방식
#### 1. 프로그램이 실행되면 JVM은 바이트코드를 인터프리터를 통해 한 줄씩 해석하며 실행한다.
#### 2. 실행 중, 특정 메서드나 코드 블록이 자주 호출되면 JIT 컴파일러가 해당 부분을 감지한다.
#### 3. 그 코드를 기계어로 변환하고 캐싱하여, 이후부터는 변환된 기계어를 사용해 더 빠르 실행한다.