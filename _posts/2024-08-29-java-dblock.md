---
layout: post
title: DB Lock
categories: Java
---
## 동시성 Concurrency

**여러 작업이 동시에 실행되는 것처럼 보이도록 관리되는 상태**로, 하나의 CPU에서 여러 작업이 실행될 때
CPU는 빠르게 작업을 전환하여 **마치 여러 작업이 동시에 실행되는 것처럼** 보이게 한다.
  
동시성을 활용하면 프로그램의 여러 부분이 동시에 실행되어, 더 많은 작업을 빠르게 처리할 수 있고, 자원을 효율적으로 사용하며,
응답을 향상시킬 수 있다.  

데이터베이스는 다수의 사용자가 데이터에 동시에 접근하게된다. 여러 사용자가 데이터베이스에 접근하는 과정에서
사용자에 대한 제어가 적절하게 이루어지지 않으면 데이터의 일관성과 무결성이 깨지게 된다.

따라서 동시성 제어를 통해 여러 사용자가 있는 상황에서 여러 개의 트랜잭션이 동시에 수행될 때, 데이터의 일관성이 깨지지 않도록 해야한다.  
 

<br>

 
#### 락의 범위
DB, 파일, 테이블, 페이지, 컬럼 등



<br>



## 낙관적 락 (Optimistic Lock)
![optimistic.png](https://github.com/user-attachments/assets/a1976ba0-b811-4270-b8c1-6e4fc408e1a5)
자원에 락을 걸지 않고, 동시성 문제가 발생하면 그때 그때 처리하는 방식이다.

수정 작업을 할때 수정했다고 명시하여 다른 트랜잭션이 동일한 조건으로 값을 수정할 수 없도록 하는 것이다.  
version과 같은 별도의 컬럼을 추가하여 충돌의 발생을 막는다.
version(hashcode/ timestamp)의 상태로 충돌을 확인하며, 충돌된 경우 롤백한다.

데이터 충돌이 자주 일어나지 않을 것이라고 예상되는 경우 주로 사용한다.
조회 작업이 많기 때문에 동시 접근 성능이 중요하다.


#### 장 단점
충돌이 안난다는 가정하에, 동시 요청에 대해서 처리 성능이 좋다.

그러나 충돌이 빈번하게 일어나는 경우, 롤백처리에 대한 비용이 많이 들어 성능에서 손해를 볼 수 있다.
또한, 개발자가 직접 롤백을 구현해야하기 때문에 시스템 구조에 따라 복잡해질 수 있다.




<br>
<br>
<br>
<br>
<br>





## 비관적 락 (Pessimistic Lock)

![pessimistic.png](https://github.com/user-attachments/assets/a5b7eb4f-082e-49d4-8a4b-013a4dd84d4b)
데이터베이스나 다른 공유 자원에 접근할 때, 데이터 충돌이 발생할 가능성을 미리 고려하고 이를 방지하기 위해
자원에 대해 락을 미리 거는 방법이다.

하나의 트랜잭션이 자원에 접근시 락을 걸고, 다른 트랜잭션이 접근하지 못하게 하여 조회 또는 갱신 처리가 완료될 때까지 락을 유지한다.

데이터베이스에서 Shared Lock(공유, 읽기 잠금) 이나 Exclusive Lock(배타, 쓰기 잠금) 을 걸 수 있다.

충돌이 자주 발생하는 상황에서 유리하며 데이터의 무결성을 보장한다. 하지만 읽기 작업이 많이 이루어지는 경우 성능이 떨어지며
서로 자원이 필요한 경우 데드락에 걸릴 가능성이 있다.

![deadlock.png](https://github.com/user-attachments/assets/c39ab451-cc23-410c-a80b-5b8e5f9e4c0a)

따라서, 조건을 추가하여 대기시간을 주거나 예외처리가 가능하다.

> ###### NO WIAT
> 잠금을 획득하지 못하면 바로 예외를 발생시킨다.   
> 트랜잭션은 다른 트랜잭션의 잠금이 해제될 때까지 대기하지 않고, 바로 실패한다.   
> 즉각 적인 실패 응답이 필요한 경우 사용
> 
> ###### WAIT[n]
> 트랜잭션이 잠금을 요청했을 때, 해당 자원이 잠겨있는 경우, 최대 n 초 동안 대기한다.  
> n 초 동안 잠금이 해제되지 않으면 예외가 발생하며 트랜잭션이 실패한다.
  


트랜잭션이 시작될 때 Shared Lock 또는 Exclusive Lock을 걸고 시작한다.



<br>



### 공유 락 (Shared Lock, Read Lock)
`특정 자원에 대해 여러 트랜잭션이 동시에 읽기 작업을 수행할 수 있도록 허용하는 락`

여러 트랜잭션이 동시에 접근하여 데이터를 읽을 수 있지만, 쓰기 작업은 제한된다. 주로 데이터 읽기의 동시성을 높이기 위해
사용하며, 어떤 자원에 공유락이 동시에 여러 개 적용될 수 있다.

일반적으로 select 할 때 공유락이 발생하며, 어떤 자원이 공유락에 걸려있는 경우 베타적 락을 걸 수 없다.

  
  
   

#### 공유락의 특징
1. **동시 읽기 허용**  
   공유락이 설정된 자원은 여러 트랜잭션이 동시에 읽을 수 있다. 
   데이터를 읽는 작업이 병렬로 수행되기 때문에 성능이 향상된다.
2. **쓰기 제한**  
   공유락이 설정된 자원에 대해 다른 트랜잭션이 쓰기 작업을 수행하려고 하면
   그 트랜잭션은 공유락이 해제될 때까지 대기해야 한다.
   데이터를 일관되게 유지하고, 읽기 중인 데이터가 변경되지 않도록 보장한다.
3. **락 충돌**  
   만약 한 트랜잭션이 공유락을 걸고 데이터를 읽고 있을 때, 다른 트랜잭션이 해당 자원에 배타락을 걸려고 시도하면 충돌이 발생한다.
   이 경우 쓰기 작업은 공유락이 해제될 때까지 대기한다.
4. **데이터 일관성 유지**  
   공유락은 트랜잭션이 데이터를 읽는 동안 해당 데이터가 다른 트랜잭션에 의해 변경되지 않도록 보호한다.


> ##### 공유락의 장단점
> 여러 트랜잭션이 동시에 데이터를 읽을 수 있어 읽기 작업의 효율성이 높으며, 데이터를 읽는 동안 데이터의 일관성을 유지할 수 있다.
> 그러나 여러 트랜잭션이 공유락을 설정한 상태엣서는 쓰기 작업을 기다려야 하기 때문에 성능저하가 발생할 수 있다.
> 또한 데드락이 발생할 수 있다.



<br>


### 배타 락 (Exclusive Lock, Write Lock)
`특정 자원(데이터, 행, 테이블 등)에 대해 하나의 트랜잭션이 독점적으로 접근할 수 있도록 설정하는 락`  

배타락이 걸린 자원에는 다른 트랜잭션이 읽기, 쓰기 작업을 수행할 수 없다.

```java
SELECT * FROM Member WHERE id = 1 FOR UPDATE;
```
  
배타락을 설정하기 위해 사용하는 구문이며, 해당 데이터에 쓰기락을 걸어, 
다른 트랜잭션이 동시에 그 데이터에 접근, 수정하지 못하도록 한다.



  

#### 배타락의 특징
1. **독점적 접근**  
   자원을 잠근 트랜잭션이 자원을 독점적으로 접그할 수 있다. 다른 트랜잭션은 해당 자원이 잠겨있는 동안 접근할 수 없다.
2. **쓰기 작업 보호**  
   일반적으로 쓰기(수정, 삭제, 삽입 등) 작업을 수행하기 전에 설정된다.
   따라서 다른 트랜잭션이 해당 자원을 동시에 수정하지 못하도록 하여 충돌을 방지한다.
3. **동시성 제어**  
   데이터를 보호하고 여러 트랜잭션이 동시에 데이터를 처리할 때 발생할 수 있는 문제를 예방한다.
4. **락 대기**  
   다른 트랜잭션이 배타락이 걸린 자원에 접근하려고 하면, 해당 트랜잭션은 락이 해제될 때까지
   대기해야 한다.


예를 들어, 은행 시스템에서 특정 계좌의 잔액을 수정하는 트랜잭션이 있다.

트랜잭션 A가 계좌의 잔액을 수정하려고 할 때, 먼저 해당 계좌 데이터에 배타락을 설정한다.
이때, 트랜잭션 A가 작업을 완료하고 락을 해제할 때까지, 트랜잭션 B는 그 계좌에 접근할 수 없게된다.
트랜잭션 A가 작업을 완료한 후 락을 해제하면, 트랜잭션 B가 계좌에 접근할 수 있다.


데이터의 무결성과 일관성을 보장하며 충돌을 미리 방지하여 데이터의 손상과 비 일관성을 방지한다.  

그러나 자원이 락이 걸린 동안 다른 트랜잭션이 대기해야 하므로 성능 저하가 발생할 수 있으며,
대기 시간이 길어질 경우, 데드락의 가능성이 증가한다.



> ##### 배타락의 장단점
> 데이터의 무결성과 일관성을 보장하며, 충돌을 사전에 방지하기 때문에 데이터의 손상과 비일관성을 방지할 수 있다.
> 
>그러나 자원이 락에 걸린동안 다른 트랜잭션이 대기해야하기 때문에 성능 저하가 발생할 수 있으며, 대기 시간이 길어질 경우 데드락의 가능성이 증가한다.







